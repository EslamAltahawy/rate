<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ุชูููู ุงูููุธู โ OCEAN (ููุงุฆู)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Cairo font -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --ocean-1:#0369a1;
      --ocean-2:#06b6d4;
      --muted:#64748b;
    }
    html,body{height:100%;font-family:'Cairo',sans-serif;background:#f7fafc;color:#071125;-webkit-font-smoothing:antialiased}
    .paper{width:210mm;max-width:100%;} /* preview sized like A4 width */
    .card{background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(7,17,34,0.06);border:1px solid #e6eef6}
    label{font-weight:600;color:#071125}
    input[type="number"], input[type="text"], input[type="date"], textarea{border:1px solid #e6eef6;padding:.5rem .6rem;border-radius:8px;background:#fff}
    .small-muted{font-size:13px;color:var(--muted)}
    .btn-primary{background:linear-gradient(90deg,var(--ocean-1),var(--ocean-2));color:#fff;padding:.6rem .9rem;border-radius:10px;font-weight:700}
    .btn-ghost{background:#fff;border:1px solid #dbeafe;padding:.5rem .8rem;border-radius:10px;color:var(--ocean-1)}
    @media print{.no-print{display:none !important} body{background:#fff} .card{box-shadow:none;border:none}}
    .preview-wrap{display:flex;justify-content:center;padding:20px}
    @media (max-width:900px){.paper{transform:scale(.9);transform-origin:top center}}
    @media (max-width:520px){.paper{transform:scale(.78)}}
  </style>
</head>
<body class="py-8">

  <div class="max-w-6xl mx-auto px-4">

    <!-- Controls -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 no-print">
      <div>
        <h1 class="text-2xl font-bold text-sky-700">ูููุฐุฌ ุชูููู ุงูููุธู โ OCEAN</h1>
        <p class="small-muted">ูุณุฎุฉ ููุงุฆูุฉ: ุชุตุฏูุฑ PDF/JPG ูุทุงุจู ููุดุงุดุฉ ุจุฏูุฉ ุทุจุงุนุฉ</p>
      </div>
      <div class="flex gap-3">
        <button id="btnCalc" class="btn-primary">ุญุณุงุจ ุงูุชูููู</button>
        <button id="btnExportPDF" class="btn-ghost"></button>
        <button id="btnExportJPG" class="btn-ghost"></button>
        <button id="btnPrint" class="btn-ghost">ุทุจุงุนุฉ</button>
      </div>
    </div>

    <!-- Preview (paper-like) -->
    <div class="preview-wrap">
      <div id="reportPaper" class="paper card p-6">
        <!-- Header -->
        <header class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-4">
            <!-- ุถุน ููู ุงูุดุนุงุฑ ูู ููุณ ุงููุฌูุฏ ูุน ูุฐุง ุงูุงุณู ุฃู ุบููุฑู -->
            <img id="logo" src="ุดุนุงุฑ ุงูุดู.jpg" alt="OCEAN" class="w-20 h-20 object-contain">
            <div>
              <div class="text-sky-600 font-bold text-lg">OCEAN</div>
              <div class="small-muted">ุชูุฑูุฑ ุชูููู ุงูููุธู ุงูุฃุณุจูุนู</div>
            </div>
          </div>
          <div class="text-right">
            <div class="small-muted">ูุณู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ</div>
            <div id="headerDate" class="text-sm text-gray-600 mt-1"></div>
          </div>
        </header>

        <hr class="border-gray-100 mb-6">

        <!-- Basic Info -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="md:col-span-2">
            <label for="empName">ุงุณู ุงูููุธู</label>
            <input id="empName" type="text" placeholder="ุฃุฏุฎู ุงุณู ุงูููุธู" class="w-full mt-1" />
          </div>
          <div>
            <label for="empDept">ุงููุณู / ุงููุธููุฉ</label>
            <input id="empDept" type="text" placeholder="ุงููุณู" class="w-full mt-1" />
          </div>
          <div>
            <label for="empId">ุฑูู ุงูููุธู</label>
            <input id="empId" type="text" placeholder="ID (ุงุฎุชูุงุฑู)" class="w-full mt-1" />
          </div>
          <div>
            <label for="weekEnd">ููุงูุฉ ุงูุฃุณุจูุน (ุชุงุฑูุฎ)</label>
            <input id="weekEnd" type="date" class="w-full mt-1" />
          </div>
        </section>

        <!-- Ratings groups -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <!-- Performance -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <div class="font-medium">ุฃุฏุงุก ุงูุนูู <span class="small-muted"></span></div>
              <div class="small-muted">ููู 1 - 5</div>
            </div>
            <div class="space-y-3">
              <div><label class="small-muted block mb-1">ุฌูุฏุฉ ุงูุนูู </label><input class="rating performance" type="number" min="1" max="5"></div>
              <div><label class="small-muted block mb-1">ุณุฑุนุฉ ุชูููุฐ ุงูุทูุจุงุช </label><input class="rating performance" type="number" min="1" max="5"></div>
              <div><label class="small-muted block mb-1">ุงูุงูุชุฒุงู ุจุงูููุงุนูุฏ</label><input class="rating performance" type="number" min="1" max="5"></div>
              <div><label class="small-muted block mb-1">ุฏูุฉ ูุฌูุฏุฉ ุงูุฌูุณุงุช </label><input class="rating performance" type="number" min="1" max="5"></div>
            </div>
          </div>

          <!-- Behavior + Appearance -->
          <div>
            <div class="mb-4">
              <div class="flex items-center justify-between mb-2"><div class="font-medium">ุงูุณููู ูุงูุงูุชุฒุงู <span class="small-muted"></span></div><div class="small-muted">ููู 1 - 5</div></div>
              <div class="space-y-2">
                <div><label class="small-muted block mb-1">ุงูุงูุชุฒุงู ุจุงูุญุถูุฑ</label><input class="rating behavior" type="number" min="1" max="5"></div>
                <div><label class="small-muted block mb-1">ุงูุชุนุงูู ูุน ุงูุฒููุงุก</label><input class="rating behavior" type="number" min="1" max="5"></div>
                <div><label class="small-muted block mb-1">ุชูุจู ุงูููุงุญุธุงุช</label><input class="rating behavior" type="number" min="1" max="5"></div>
              </div>
            </div>

            <div>
              <div class="flex items-center justify-between mb-2"><div class="font-medium">ุงููุธูุฑ ุงูุนุงู <span class="small-muted"></span></div><div class="small-muted">ููู 1 - 5</div></div>
              <div class="space-y-2">
                <div><label class="small-muted block mb-1">ุงูุงูุถุจุงุท ุงูุดุฎุตู</label><input class="rating appearance" type="number" min="1" max="5"></div>
                <div><label class="small-muted block mb-1">ุงูุงูุชุฒุงู ุจุงููุธูุฑ</label><input class="rating appearance" type="number" min="1" max="5"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Clients + Completion + Deficit -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <div class="flex items-center justify-between mb-2"><div class="font-medium">ุงูุชุนุงูู  ุนูู ูุงุชุณุงุจ <span class="small-muted"></span></div><div class="small-muted">ููู 1 - 5</div></div>
            <div class="space-y-2">
              <div><label class="small-muted block mb-1">ุฃุณููุจ ุงูุชูุงุตู</label><input class="rating clients" type="number" min="1" max="5"></div>
              <div><label class="small-muted block mb-1">ุณุฑุนุฉ ุงูุงุณุชุฌุงุจุฉ</label><input class="rating clients" type="number" min="1" max="5"></div>
              <div><label class="small-muted block mb-1">ุฏูุฉ ุงููุนูููุงุช / ุฑุถุง ุงูุนููุงุก</label><input class="rating clients" type="number" min="1" max="5"></div>
            </div>
          </div>

          <div>
            <!-- <div class="mb-2"><label class="font-medium">ุงูุฅูุฌุงุฒ ุฎูุงู ุงูุฃุณุจูุน</label></div>
            <div class="grid grid-cols-2 gap-3">
              <div><label class="small-muted block mb-1">ุนุฏุฏ ุงูููุงู ุงูููููุฉ</label><input id="tasksAssigned" type="number" min="0"></div>
              <div><label class="small-muted block mb-1">ุนุฏุฏ ุงูููุงู ุงูููุฌุฒุฉ</label><input id="tasksDone" type="number" min="0"></div>
            </div> -->
            <div class="mt-3">
              <label class="small-muted block mb-1">ุงููุณุจุฉ ุงูุนุงูู ููุงุฏุงุก ุงูุงุณุจูุนู</label>
              <input id="completionPct" type="number" min="0" max="100" class="w-full" />
            </div>

            <div class="mt-3">
              <label class="small-muted block mb-1">ุฅุฌูุงูู ุงูุนุฌุฒ ุฎูุงู ุฌูุณุงุช ุงูุฃุณุจูุน (ุจุงูุฑูุงู)</label>
              <input id="deficit" type="number" min="0" placeholder="ูุซูุงู 250" class="w-full" />
            </div>

            <div class="mt-3">
              <label class="small-muted block mb-1">ููุงุญุธุงุช (ุงุฎุชูุงุฑู)</label>
              <textarea id="notes" rows="3" class="w-full"></textarea>
            </div>
          </div>
        </section>

        <!-- Result -->
        <section class="p-4 bg-sky-50 rounded border border-sky-100 mb-6">
          <div class="flex items-center justify-between">
            <div>
              <div class="small-muted">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ</div>
              <div id="finalResult" class="text-2xl font-bold mt-1">--</div>
              <div id="finalLabel" class="text-sm small-muted mt-1"></div>
            </div>
            <div style="width:62%">
              <div class="small-muted mb-2">ุดุฑูุท ุงูุชูููู</div>
              <div class="w-full bg-gray-200 rounded h-4 overflow-hidden">
                <div id="finalBar" class="h-4" style="width:0%; background:#93c5fd;"></div>
              </div>
            </div>
          </div>
          <div class="mt-3 small-muted"></div>
        </section>

        <hr class="border-gray-100 mb-4">

        <!-- Footer: signature -->
        <footer class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
          <div class="flex-1">
            <div class="small-muted mb-1">ุชูููุน ุงูุชูู ููุฏุฑ:</div>
            <div style="height:44px;width:100%;border-bottom:1px dashed #e2e8f0;margin-top:4px;"></div>

            <div class="mt-3">
              <label for="leaderName" class="small-muted block mb-1">ุงุณู ุงูุชูู ููุฏุฑ</label>
              <input id="leaderName" type="text" placeholder="ุฃุฏุฎู ุงุณูู ููุง" class="w-full md:w-80 border border-gray-200 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-sky-400">
            </div>
          </div>

          <div class="text-right small-muted">
            <div>ุงูุชุงุฑูุฎ:</div>
            <div id="footerDate" class="mt-2 text-gray-700 font-medium"></div>
          </div>
        </footer>

      </div> <!-- reportPaper -->
    </div> <!-- preview-wrap -->
  </div> <!-- container -->

<script>
/* ======= Settings & Utilities ======= */
const WEIGHTS = { perf:0.40, behavior:0.25, appearance:0.15, clients:0.20 };

/* rating 1..5 => pct 0..100 */
function ratingToPct(r){ return ((r - 1) / 4) * 100; }

/* set dates */
const now = new Date();
document.getElementById('headerDate').textContent = now.toLocaleDateString('ar-EG');
document.getElementById('footerDate').textContent = now.toLocaleDateString('ar-EG');

/* read group values and validate */
function readGroup(selector, name){
  const els = Array.from(document.querySelectorAll(selector));
  if(els.length === 0) return { avg:0, pct:0 };
  const vals = els.map(e => {
    const v = parseFloat(e.value);
    if(Number.isNaN(v) || v < 1 || v > 5) throw new Error('ุงูุฑุฌุงุก ุฅุฏุฎุงู ููู ุตุญูุญุฉ ูู 1 ุฅูู 5 ูู: ' + name);
    return v;
  });
  const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
  return { avg, pct: ratingToPct(avg) };
}

/* compute final score, apply deficit penalty */
function computeFinal() {
  const perf = readGroup('.performance', 'ุฃุฏุงุก ุงูุนูู');
  const behavior = readGroup('.behavior', 'ุงูุณููู');
  const appearance = readGroup('.appearance', 'ุงููุธูุฑ');
  const clients = readGroup('.clients', 'ุงูุชุนุงูู ูุน ุงูุนููุงุก');

  // ุงููุฒู ุงูููู ูุจู ุงุญุชุณุงุจ ุงูุฅูุฌุงุฒ
  const weighted = (
    perf.pct * WEIGHTS.perf +
    behavior.pct * WEIGHTS.behavior +
    appearance.pct * WEIGHTS.appearance +
    clients.pct * WEIGHTS.clients
  );

  // ุงุญุชุณุงุจ ูุณุจุฉ ุงูุฅูุฌุงุฒ
  const completionField = document.getElementById('completionPct').value;
  let completion = null;
  if (completionField !== '') {
    completion = parseFloat(completionField);
    if (Number.isNaN(completion) || completion < 0 || completion > 100)
      throw new Error('ุฃุฏุฎู ูุณุจุฉ ุฅูุฌุงุฒ ุตุญูุญุฉ ูู 0 ุฅูู 100');
  } else {
    const assigned = parseFloat(document.getElementById('tasksAssigned').value || '0');
    const done = parseFloat(document.getElementById('tasksDone').value || '0');
    if (assigned > 0)
      completion = Math.max(0, Math.min(100, (done / assigned) * 100));
    else
      throw new Error('ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุณุจุฉ ุงูุฅูุฌุงุฒ ุฃู ุนุฏุฏ ุงูููุงู ุงูููููุฉ ูุงูููุฌุฒุฉ.');
  }

  // ุงููุชูุฌุฉ ุงูุฃุณุงุณูุฉ ูุจู ุฎุตู ุงูุนุฌุฒ
  const baseFinal = Math.round(weighted * (completion / 100));

  // ุฎุตู ุงูุนุฌุฒ: ูู 100 ุฑูุงู = 1% ุฎุตูุ ุจุญุฏ ุฃูุตู 20%
  const deficit = parseFloat(document.getElementById('deficit').value || '0');
  if (Number.isNaN(deficit) || deficit < 0)
    throw new Error('ุงูุฑุฌุงุก ุฅุฏุฎุงู ูููุฉ ุตุญูุญุฉ ููุนุฌุฒ');
  const penaltyFraction = Math.min(0.20, deficit / 10000);
  const finalAfterPenalty = Math.round(baseFinal * (1 - penaltyFraction));

  // --- ๐ ุชุญููู ุงูุชููููุงุช ---
  const allRatings = Array.from(document.querySelectorAll('.rating'))
    .map(e => parseFloat(e.value))
    .filter(v => !Number.isNaN(v));

  const midRatings = allRatings.filter(v => v >= 3 && v <= 4).length;
  const midRatio = allRatings.length > 0 ? (midRatings / allRatings.length) : 0;

  // --- ๐ง ุชุญุฏูุฏ ุงูุชุตููู ---
  let label = 'ุถุนูู', color = '#ef4444';
  if (finalAfterPenalty >= 95) { label = 'ููุชุงุฒ'; color = '#0ea5e9'; }
  else if (finalAfterPenalty >= 85) { label = 'ุฌูุฏ ุฌุฏูุง'; color = '#10b981'; }
  else if (finalAfterPenalty >= 70) { label = 'ุฌูุฏ'; color = '#f59e0b'; }

  // --- โ๏ธ ุชุทุจูู ุดุฑุท ุงูู 3 ุฅูู 4 ---
  // ุฅุฐุง ูุงูุช ุฃุบูุจ ุงูุฃุณุงุณุงุช ุฃูู ูู 50% ุชูููููุง ุจูู 3 ู4ุ ูุฎูุถ ุงูุชูููู ุฅูู ุถุนูู
  if (label === 'ุฌูุฏ' && midRatio < 0.5) {
    label = 'ุถุนูู';
    color = '#ef4444';
  }

  return {
    final: finalAfterPenalty,
    base: baseFinal,
    label,
    color,
    penaltyPercent: Math.round(penaltyFraction * 100),
    deficit
  };
}


/* UI update */
document.getElementById('btnCalc').addEventListener('click', () => {
  try{
    const r = computeFinal();
    document.getElementById('finalResult').textContent = r.final + ' %';
    document.getElementById('finalLabel').textContent = r.label + (r.penaltyPercent ? (' โข ุฎุตู ' + r.penaltyPercent + '% ุจุณุจุจ ุนุฌุฒ ' + r.deficit + ' ุฑ.ุณ') : '');
    const bar = document.getElementById('finalBar');
    bar.style.width = r.final + '%';
    bar.style.background = r.color;
  } catch(e){
    alert(e.message || 'ุฎุทุฃ ูู ุงูุญุณุงุจ');
  }
});

/* ===== High-res render & export (PDF / JPG) =====
   Strategy:
   - Render #reportPaper via html2canvas at high 'scale' to approach A4 @300DPI
   - Wait for document.fonts.ready to ensure text is rasterized correctly
   - For PDF: convert px->mm using 300 DPI and embed image into jsPDF A4
   - For JPG: download the high-res JPEG dataURL
*/
async function renderHighRes(element){
  if(document.fonts && document.fonts.ready) await document.fonts.ready;

  const rect = element.getBoundingClientRect();
  const cssW = rect.width;

  const targetPxW = 2480; // A4 width @300dpi
  let scale = Math.max(1, Math.ceil(targetPxW / cssW));
  scale = Math.min(scale, 6); // clamp to avoid memory issues

  const canvas = await html2canvas(element, {
    scale,
    useCORS: true,
    backgroundColor: '#ffffff',
    scrollY: -window.scrollY
  });
  return canvas;
}

document.getElementById('btnExportPDF').addEventListener('click', async () => {
  try{
    // ensure calculation applied
    document.getElementById('btnCalc').click();

    const elem = document.getElementById('reportPaper');
    const canvas = await renderHighRes(elem);

    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','mm','a4');

    const pxW = canvas.width, pxH = canvas.height;
    const widthMm = (pxW / 300) * 25.4;
    const heightMm = (pxH / 300) * 25.4;

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    let renderW = widthMm, renderH = heightMm;
    if(renderH > pageH){
      const ratio = pageH / renderH;
      renderH = pageH;
      renderW = renderW * ratio;
    }
    const x = (pageW - renderW) / 2;
    pdf.addImage(imgData, 'JPEG', x, 0, renderW, renderH, undefined, 'FAST');
    const filename = (document.getElementById('empName').value || 'ุชูููู_ุงูููุธู').replace(/\s+/g,'_') + '_OCEAN_Report.pdf';
    pdf.save(filename);
  } catch(err){
    console.error(err);
    alert('ูุดู ุชุตุฏูุฑ PDF: ' + (err.message || err));
  }
});

document.getElementById('btnExportJPG').addEventListener('click', async () => {
  try{
    document.getElementById('btnCalc').click();
    const elem = document.getElementById('reportPaper');
    const canvas = await renderHighRes(elem);
    const dataUrl = canvas.toDataURL('image/jpeg', 1.0);
    const link = document.createElement('a');
    const name = (document.getElementById('empName').value || 'ุชูููู_ุงูููุธู').replace(/\s+/g,'_') + '_OCEAN_300DPI.jpg';
    link.href = dataUrl;
    link.download = name;
    document.body.appendChild(link);
    link.click();
    link.remove();
  } catch(err){
    console.error(err);
    alert('ูุดู ุชุตุฏูุฑ JPG: ' + (err.message || err));
  }
});

/* Print */
document.getElementById('btnPrint').addEventListener('click', () => {
  document.getElementById('btnCalc').click();
  window.print();
});
</script>

</body>
</html>
